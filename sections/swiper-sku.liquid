<style>
  #shopify-section-{{ section.id }} {}

  .swiper-automatic-sku {
    width: 100%;
    background-color: {{ section.settings.backgroundColor }};
    overflow: hidden;
    position: relative;
    padding-top: 20px;
    padding-bottom: 20px;
    margin-top: 20px;
    margin-bottom: 20px;
  }

  .swiper-automatic-sku .swiper-automatic-title {
    width: 100%;
    max-width: 1600px;
    margin: 0;
    padding-left: 245px;important!
    font-weight: bold;
    margin-bottom: 20px;
    font-family: var(--font-light-family);
font-weight: var(--font-light-weight);
font-style: var(--font-light-style);
  }

  .color-sku-container { display: flex; justify-content: center; margin-bottom: 20px; }
  .color-sku-oval { display: inline-flex; gap: 12px; padding: 10px 20px; border-radius: 40px; background: #EFEFF2; }
  .color-dot { position: relative; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; }
  .color-dot::before { content:''; position:absolute; inset:-4px; border-radius:50%; background:transparent; border:2px solid transparent; transition:border-color .25s; }
  .color-dot.active::before { border-color: currentColor; }
  .color-dot .circle { width:100%; height:100%; border-radius:50%; }

  .swiper-automatic-sku .swiper-slide img {
    width:100%; height:auto; border-radius:20px; transition:opacity .3s; display:block;
  }

  .swiper-automatic-sku .bottom-pagination {
    display:flex; align-items:center; justify-content:center; gap:20px; margin-top:20px;
    position:relative; z-index:1; isolation:isolate;
  }
  .swiper-automatic-sku .automatic-pagination {
    display:flex; gap:8px; padding:26px; border-radius:30px; background:#EFEFF2; position:relative; z-index:1;
  }
  .swiper-automatic-sku .bar { width:6px; height:6px; background:#717174; border-radius:50%; overflow:hidden; position:relative; transition:.3s ease; }
  .swiper-automatic-sku .bar.active { width:40px; height:6px; border-radius:15px; }
  .swiper-automatic-sku .fill { width:0%; height:100%; background:#29292A; transition:none; position:absolute; top:0; left:0; }

  .swiper-automatic-sku .controls button { cursor:pointer; border:none; background:none; position:relative; z-index:3; }

  /* 按钮外观（保持你原设计） */
  .swiper-automatic-sku .icon {
    display:inline-flex; align-items:center; justify-content:center;
    width:58px; height:58px; border-radius:50%;
    background-color:#EFEFF2; box-shadow:0 4px 8px rgba(0,0,0,.2);
  }

  /* —— 关键：用 data-icon 隔离一切外部污染 —— */
  .swiper-automatic-sku .icon [data-icon]::before,
  .swiper-automatic-sku .icon [data-icon]::after{ content:none !important; display:none !important; }

  /* 强制 SVG 显示；这里不依赖 currentColor，直接写死填色，避免全局干扰 */
  .swiper-automatic-sku .icon [data-icon] svg{ display:block !important; width:24px; height:24px; }
  .swiper-automatic-sku .icon [data-icon] svg,
  .swiper-automatic-sku .icon [data-icon] svg *{ fill:#000 !important; stroke:none !important; } /* 纯黑，如需深灰改成 #29292A */

  #shopify-section-{{ section.id }} .swiper-automatic-title {
    font-size: {{ section.settings.titleSizePc }}px;
    line-height: {{ section.settings.titleSizePcLineHeight }}px;
  }
  /* 强制当前 section 的标题字号生效 */
#shopify-section-{{ section.id }} .swiper-automatic-title {
  font-size: {{ section.settings.titleSizePc }}px !important;
  line-height: {{ section.settings.titleSizePcLineHeight }}px !important;
}

/* 关键：让标题内的所有子节点都继承父级字号，避免被全局样式写死 */
#shopify-section-{{ section.id }} .swiper-automatic-title * {
  font-size: inherit !important;
}

  /* 移动端覆盖 */
@media (max-width: 768px) {
  #shopify-section-{{ section.id }} .swiper-automatic-title {
    padding-left: 40px;
    font-size: {{ section.settings.titleSizeMobile }}px !important;title
    line-height: {{ section.settings.titleSizeMobileLineHeight }}px !important;
  }
  
}
</style>

<div class="swiper-automatic-sku" data-section-id="{{ section.id }}">
  <div class="swiper-automatic-title">{{ section.settings.title }}</div>



  <div class="swiper-container automatic-container-{{ section.id }}">
    <div class="swiper-wrapper">
      {%- assign first_sku = section.blocks | where: 'type', 'color_sku' | first -%}
      {%- for i in (1..6) -%}
        {%- assign pc_key = 'image' | append: i -%}
        {%- assign m_key  = 'image' | append: i | append: '_mobile' -%}
        {%- assign pc_img = first_sku.settings[pc_key] -%}
        {%- assign m_img  = first_sku.settings[m_key] -%}
        {%- if pc_img != blank or m_img != blank -%}
          <div class="swiper-slide">
            <picture>
              {%- if m_img != blank -%}
                <source media="(max-width: 768px)" srcset="{{ m_img | img_url: '750x750' }}">
              {%- endif -%}
              <img src="{{ pc_img | default: m_img | img_url: '2048x2048' }}" alt="" loading="lazy">
            </picture>
          </div>
        {%- endif -%}
      {%- endfor -%}
    </div>
  </div>

    <div class="color-sku-container">
    <div class="color-sku-oval">
      {% for sku in section.blocks %}
        <div class="color-dot {% if forloop.first %}active{% endif %}"
             data-sku-index="{{ forloop.index0 }}"
             style="color:{{ sku.settings.color }}">
          <span class="circle" style="background-color:{{ sku.settings.color }}"></span>
        </div>
      {% endfor %}
    </div>
  </div>
  
<div class="bottom-pagination">
    <div class="controls">
      <!-- 去掉 .play/.pause/.replay 这些易冲突的类，只留 .icon；用 data-state 存状态 -->
      <button class="automatic-play-pause-btn" data-section="{{ section.id }}" data-state="play">
        <span class="icon"><span data-icon></span></span>
      </button>
    </div>
    <div class="automatic-pagination automatic-pagination-{{ section.id }}"></div>
  </div> 
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const sectionId = '{{ section.id }}';
  const wrapper = document.querySelector(`[data-section-id="${sectionId}"]`);
  const container = wrapper.querySelector(`.automatic-container-${sectionId}`);
  const paginationEl = wrapper.querySelector(`.automatic-pagination-${sectionId}`);
  const playBtn = wrapper.querySelector('.automatic-play-pause-btn');
  const iconHolder = playBtn.querySelector('[data-icon]');

  let swiper;
  const DURATION = 4000;

  let isPlaying = false;
  let fills = [];
  let rafId = null;
  let progressStartTime = 0;
  let accumulated = 0;
  let touchStartIndex = 0;

  /* —— 颜色写死在 SVG（纯黑 #000，如需改回深灰把 #000 改成 #29292A） —— */
  const SVG = {
    play:  `<svg viewBox="0 0 56 56"><path d="m23.7555 36.6237c.4478 0 .8598-.1343 1.4241-.4568l10.9178-6.3322c.8598-.5016 1.3614-1.021 1.3614-1.8361 0-.8061-.5016-1.3255-1.3614-1.8271l-10.9178-6.3322c-.5643-.3314-.9762-.4657-1.4241-.4657-.9315 0-1.7555.7165-1.7555 1.9435v13.3629c0 1.227.824 1.9435 1.7555 1.9435z"/></svg>`,
    pause: `<svg viewBox="0 0 24 24"><path d="M6 4h4v16H6z"/><path d="M14 4h4v16h-4z"/></svg>`,
    replay:`<svg viewBox="0 0 56 56"><path d="M28 0C12.536 0 0 12.536 0 28s12.536 28 28 28 28-12.536 28-28S43.464 0 28 0zm0 49C14.193 49 3 37.807 3 24S14.193 3 28 3s25 11.193 25 25-11.193 25-25 25z"/><path d="M39.5 24L22.5 14v20z"/></svg>`
  };

  function setIcon(which){
    iconHolder.innerHTML = SVG[which];
    playBtn.setAttribute('data-state', which); // 记录状态
  }

  // ---------- Swiper ----------
  function initSwiper() {
    swiper = new Swiper(container, {
      loop: false,
      slidesPerView: 1.5,
      centeredSlides: false,
      spaceBetween: 100,
      observer: true,
      observeParents: true,
      autoplay: false,
      slidesOffsetBefore: 245,
      slidesOffsetAfter: 0,
      on: {
        slideChange() {
          accumulated = 0;
          updateProgressBars();
          if (isPlaying) play(true);
          else render(0);
        },
        slideChangeTransitionEnd() { if (!isPlaying) render(0); }
      },
     breakpoints: {
        0:   { slidesPerView: 1.2, spaceBetween: 20,  slidesOffsetBefore: 40, slidesOffsetAfter: 20 },
        769: { slidesPerView: 1.5, spaceBetween: 100, slidesOffsetBefore: 245, slidesOffsetAfter: 100 }
      }
    });

    buildProgressBars();
    updateProgressBars();
  }

  // ---------- 进度条 ----------
  function buildProgressBars() {
    paginationEl.innerHTML = '';
    fills = [];
    for (let i = 0; i < swiper.slides.length; i++) {
      const bar = document.createElement('div');
      bar.className = 'bar';
      const fill = document.createElement('div');
      fill.className = 'fill';
      bar.appendChild(fill);
      paginationEl.appendChild(bar);
      fills.push(fill);

      bar.addEventListener('click', () => {
        if (isPlaying) { accumulated = 0; swiper.slideTo(i); play(true); }
        else { accumulated = 0; swiper.slideTo(i); render(0); setIcon('play'); }
      });
    }
  }

  function updateProgressBars() {
    const current = swiper.realIndex;
    fills.forEach((fill, idx) => {
      const bar = fill.parentElement;
      if (idx === current) { bar.classList.add('active'); }
      else {
        bar.classList.remove('active');
        fill.style.transition = 'none';
        fill.style.width = idx < current ? '100%' : '0%';
      }
    });
  }

  const idx = () => swiper?.realIndex || 0;

  function progressRatio(nowMs){
    const now = nowMs ?? performance.now();
    const elapsed = isPlaying ? (now - progressStartTime + accumulated) : accumulated;
    return Math.min(elapsed / DURATION, 1);
  }

  function render(r){
    const i = idx();
    for (let k=0; k<fills.length; k++){
      const el = fills[k];
      el.style.transition = 'none';
      if (k < i) el.style.width = '100%';
      else if (k > i) el.style.width = '0%';
      else el.style.width = `${Math.max(0, Math.min(100, (r||0)*100))}%`;
      el.parentElement.classList.toggle('active', k === i);
    }
  }

  function tick(){
    const r = progressRatio();
    render(r);
    if (r < 1) rafId = requestAnimationFrame(tick);
    else finishSlideOrEnd();
  }

  function play(reset=false){
    isPlaying = true;
    setIcon('pause');
    cancelAnimationFrame(rafId);
    if (reset) accumulated = 0;
    progressStartTime = performance.now();
    rafId = requestAnimationFrame(tick);
  }

  function pause(){
    if (!isPlaying) return;
    isPlaying = false;
    const now = performance.now();
    accumulated = (now - progressStartTime) + accumulated;
    cancelAnimationFrame(rafId);
    render(progressRatio(now));
    setIcon('play');
  }

  function finishSlideOrEnd(){
    if (idx() < swiper.slides.length - 1) swiper.slideNext();
    else {
      isPlaying = false;
      cancelAnimationFrame(rafId);
      accumulated = DURATION;
      render(1);
      setIcon('replay');
    }
  }

  function bindTouchGuards(){
    swiper.on('touchStart', () => { touchStartIndex = swiper.realIndex; });
    swiper.on('touchEnd', () => {
      const changed = swiper.realIndex !== touchStartIndex;
      if (!changed) return;
      if (isPlaying) { accumulated = 0; play(true); }
      else { accumulated = 0; render(0); setIcon('play'); }
    });
  }

  document.addEventListener('visibilitychange', () => {
    if (document.hidden) pause();
    else if (playBtn.getAttribute('data-state') !== 'replay' && !isPlaying) {
      render(progressRatio());
    }
  });

  // 预加载（保持你的版本）
  function preloadSkuImages(pcArray = [], mArray = [], timeoutMs = 6000) {
    const urls = [];
    const push = (u) => { if (u && typeof u === 'string') urls.push(u); };
    const maxLen = Math.max(pcArray.length, mArray.length);
    for (let i = 0; i < maxLen; i++) { push(pcArray[i]); push(mArray[i]); }
    const uniq = Array.from(new Set(urls.filter(Boolean)));
    if (uniq.length === 0) return Promise.resolve();
    const tasks = uniq.map((src) => new Promise((resolve) => {
      const img = new Image(); img.src = src;
      if (img.decode) img.decode().then(resolve).catch(resolve);
      else img.onload = img.onerror = () => resolve();
      setTimeout(() => resolve(), timeoutMs);
    }));
    return Promise.allSettled(tasks).then(() => undefined);
  }

  const skuPc = [
    {% for sku in section.blocks %}
      [{% for i in (1..6) %}{% assign pc_key = 'image' | append: i %}{% assign pc_img = sku.settings[pc_key] %}{% if pc_img != blank %}"{{ pc_img | img_url: '2048x2048' }}"{% else %}""{% endif %}{% unless forloop.last %},{% endunless %}{% endfor %}]
      {% unless forloop.last %},{% endunless %}
    {% endfor %}
  ];
  const skuMobile = [
    {% for sku in section.blocks %}
      [{% for i in (1..6) %}{% assign m_key = 'image' | append: i | append: '_mobile' %}{% assign m_img = sku.settings[m_key] %}{% if m_img != blank %}"{{ m_img | img_url: '750x750' }}"{% else %}""{% endif %}{% unless forloop.last %},{% endunless %}{% endfor %}]
      {% unless forloop.last %},{% endunless %}
    {% endfor %}
  ];

  function setSlidePictureContent(slideEl, pcUrl, mUrl, idx) {
    const effectivePc = pcUrl || mUrl || '';
    const eager = idx === 0 ? 'eager' : 'lazy';
    slideEl.innerHTML = `
      <picture>
        ${mUrl ? `<source media="(max-width: 699px)" srcset="${mUrl}">` : ''}
        <img src="${effectivePc}" alt="" loading="${eager}" decoding="async">
      </picture>
    `;
  }

  async function updateSwiperSlidesSmooth(pcArray, mArray) {
    try { await preloadSkuImages(pcArray, mArray); } catch(e) {}
    const maxLen = Math.max(pcArray.length, mArray.length);
    for (let i = 0; i < maxLen; i++) {
      const pc = pcArray[i] || '';
      const mv = mArray[i] || '';
      if (!pc && !mv) continue;
      if (swiper.slides[i]) { setSlidePictureContent(swiper.slides[i], pc, mv, i); swiper.slides[i].style.display = 'block'; }
      else { swiper.appendSlide('<div class="swiper-slide"></div>'); setSlidePictureContent(swiper.slides[swiper.slides.length-1], pc, mv, i); }
    }
    for (let j = maxLen; j < swiper.slides.length; j++) swiper.slides[j].style.display = 'none';

    swiper.update();
    swiper.slideTo(0,0);

    accumulated = 0;
    buildProgressBars();
    updateProgressBars();
    if (isPlaying) play(true); else { render(0); setIcon('play'); }
  }

  const colorDots = wrapper.querySelectorAll('.color-dot');
  colorDots.forEach(dot => {
    dot.addEventListener('click', async () => {
      colorDots.forEach(d => d.classList.remove('active'));
      dot.classList.add('active');
      const i = parseInt(dot.dataset.skuIndex, 10);
      await updateSwiperSlidesSmooth(skuPc[i] || [], skuMobile[i] || []);
    });
  });

  playBtn.addEventListener('click', () => {
    if (playBtn.getAttribute('data-state') === 'replay') {
      swiper.slideTo(0,0); accumulated = 0; play(true); return;
    }
    isPlaying ? pause() : play(false);
  });

  initSwiper();
  bindTouchGuards();

  (async () => { await updateSwiperSlidesSmooth(skuPc[0] || [], skuMobile[0] || []); })();

  setIcon('play');
  render(0);
});
</script>

{% schema %}
{
  "name": "Swiper Automatic SKU",
  "settings": [
    { "type": "color", "id": "backgroundColor", "label": "Background color", "default": "#ffffff" },
    { "type": "text",  "id": "title", "label": "Section title", "default": "Automatic Slider" },
    { "type": "range", "id": "titleSizePc", "label": "Title size PC", "min": 12, "max": 72, "step": 1, "unit": "px", "default": 68 },
    { "type": "range", "id": "titleSizePcLineHeight", "label": "Title PC line-height", "min": 0, "max": 200, "step": 2, "unit": "px", "default": 80 },
    { "type": "range", "id": "titleSizeMobile", "label": "Title size mobile", "min": 12, "max": 72, "step": 1, "unit": "px", "default": 24 },
    { "type": "range", "id": "titleSizeMobileLineHeight", "label": "Title mobile line-height", "min": 0, "max": 200, "step": 2, "unit": "px", "default": 28 }
  ],
  "blocks": [{
    "type": "color_sku",
    "name": "Color SKU",
    "settings": [
      { "type": "color", "id": "color", "label": "Color value" },
      { "type": "text",  "id": "title", "label": "Color title" },
      { "type": "image_picker", "id": "image1", "label": "Image 1 (PC)" },
      { "type": "image_picker", "id": "image1_mobile", "label": "Image 1 (Mobile)" },
      { "type": "image_picker", "id": "image2", "label": "Image 2 (PC)" },
      { "type": "image_picker", "id": "image2_mobile", "label": "Image 2 (Mobile)" },
      { "type": "image_picker", "id": "image3", "label": "Image 3 (PC)" },
      { "type": "image_picker", "id": "image3_mobile", "label": "Image 3 (Mobile)" },
      { "type": "image_picker", "id": "image4", "label": "Image 4 (PC)" },
      { "type": "image_picker", "id": "image4_mobile", "label": "Image 4 (Mobile)" },
      { "type": "image_picker", "id": "image5", "label": "Image 5 (PC)" },
      { "type": "image_picker", "id": "image5_mobile", "label": "Image 5 (Mobile)" },
      { "type": "image_picker", "id": "image6", "label": "Image 6 (PC)" },
      { "type": "image_picker", "id": "image6_mobile", "label": "Image 6 (Mobile)" }
    ]
  }],
  "presets": [{ "name": "Swiper Automatic SKU" }]
}
{% endschema %}
