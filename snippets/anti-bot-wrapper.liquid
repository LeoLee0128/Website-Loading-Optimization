{%- comment -%}
  ============================================
  åçˆ¬è™« Head åŒ…è£…å™¨ Snippetï¼ˆä¸“é—¨ç”¨äº head æ ‡ç­¾ï¼‰
  ============================================
  åŠŸèƒ½ï¼šæ£€æµ‹è®¿é—®è€…çš„æµè§ˆå™¨ç¯å¢ƒï¼Œå¦‚æœæ˜¯å¯ç–‘çš„çˆ¬è™«/æœåŠ¡å™¨ç¯å¢ƒï¼Œ
       åˆ™éšè— head ä¸­çš„æŸäº›å†…å®¹ï¼›å¦‚æœæ˜¯æ™®é€šç”¨æˆ·ï¼Œåˆ™æ­£å¸¸æ˜¾ç¤ºã€‚
  
  æ³¨æ„ï¼šæ­¤ snippet ä¸“é—¨ç”¨äº head æ ‡ç­¾ï¼Œä¼šç›´æ¥è¾“å‡ºåˆ° head ä¸­ï¼Œ
       è€Œä¸æ˜¯ä½¿ç”¨å®¹å™¨ divï¼ˆå› ä¸º head å†…å®¹å¿…é¡»ç«‹å³è§£æï¼‰
  
  ä½¿ç”¨æ–¹æ³•ï¼š
  {% capture protected_head_content %}
    <!-- éœ€è¦ä¿æŠ¤çš„ head å†…å®¹ -->
  {% endcapture %}
  {% render 'anti-bot-head-wrapper', content: protected_head_content %}
  ============================================
{%- endcomment -%}

{%- comment -%}
  å‚æ•°è¯´æ˜ï¼š
  - content: éœ€è¦ä¿æŠ¤çš„å†…å®¹ï¼ˆé€šè¿‡ capture æ•è·çš„ HTMLï¼‰
  - debug: å¯é€‰çš„è°ƒè¯•æ¨¡å¼ï¼Œè®¾ä¸º true æ—¶ä¼šåœ¨æ§åˆ¶å°è¾“å‡ºæ£€æµ‹ä¿¡æ¯ï¼ˆé»˜è®¤ falseï¼‰
{%- endcomment -%}

{%- assign head_wrapper_id = 'head-anti-bot-' | append: 'now' | date: '%s' -%}

{%- comment -%}
  å¯¹äº head å†…å®¹ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸åŒçš„ç­–ç•¥ï¼š
  1. å…³é”®å†…å®¹ï¼ˆå¦‚ charsetã€viewportã€titleï¼‰å¿…é¡»ç›´æ¥è¾“å‡º
  2. éå…³é”®å†…å®¹å¯ä»¥é€šè¿‡ JavaScript åŠ¨æ€æ’å…¥
  3. ä½¿ç”¨ noscript æ ‡ç­¾ä½œä¸ºé™çº§æ–¹æ¡ˆï¼Œç¡®ä¿å†…å®¹åœ¨æ—  JS æ—¶ä¹Ÿèƒ½æ˜¾ç¤º
{%- endcomment -%}

{%- comment -%} é™çº§æ–¹æ¡ˆï¼šæ—  JavaScript æ—¶æ˜¾ç¤ºå†…å®¹ {%- endcomment -%}
<noscript id="head-fallback-{{ head_wrapper_id }}">
  {{ content }}
</noscript>

{%- comment -%} ä½¿ç”¨è„šæœ¬åŠ¨æ€æ’å…¥å—ä¿æŠ¤çš„å†…å®¹ {%- endcomment -%}
<script>
  (function() {
    'use strict';
    
    // è°ƒè¯•æ¨¡å¼ï¼ˆé€šè¿‡å‚æ•°æ§åˆ¶ï¼‰
    var DEBUG_MODE = {% if debug == true %}true{% else %}false{% endif %};
    
    // åŸºæœ¬æ—¥å¿—ï¼šç¡®è®¤è„šæœ¬å·²åŠ è½½
    if (DEBUG_MODE) {
      console.log('ğŸ”§ åçˆ¬è™« Head åŒ…è£…å™¨è„šæœ¬å·²åŠ è½½');
    }
    
    // ç¡®ä¿ DOM å·²åŠ è½½åå†æ‰§è¡Œ
    function performHeadDetection() {
      // åŸºæœ¬æ—¥å¿—ï¼šç¡®è®¤å‡½æ•°å·²æ‰§è¡Œ
      if (DEBUG_MODE) {
        console.log('ğŸ”§ å¼€å§‹æ‰§è¡Œ Head åçˆ¬è™«æ£€æµ‹...');
      }
      
      try {
        // å®šä¹‰å¯ç–‘å¹³å°åˆ—è¡¨ï¼ˆé€šå¸¸æ˜¯çˆ¬è™«æˆ–æœåŠ¡å™¨ç¯å¢ƒï¼‰
        var suspiciousPlatforms = [
          'Linux x86_64',
          'Linux i686',
          'Linux i386'
        ];
        
        // è·å–å½“å‰æµè§ˆå™¨å¹³å°ä¿¡æ¯
        var platform = (window.navigator && window.navigator.platform) ? 
                       window.navigator.platform : '';
        
        // æ£€æµ‹æ˜¯å¦ä¸ºå¯ç–‘å¹³å°
        var isSuspiciousPlatform = suspiciousPlatforms.some(function(suspiciousPlatform) {
          return platform === suspiciousPlatform;
        });
        
        // æ£€æµ‹ PageSpeed çˆ¬è™«ç‰¹å¾
        var isPageSpeedBot = false;
        
        // 1. æ£€æµ‹ User-Agent ä¸­çš„ PageSpeed/Lighthouse æ ‡è¯†
        var userAgent = (window.navigator && window.navigator.userAgent) ? 
                        window.navigator.userAgent : '';
        var pageSpeedKeywords = [
          'Pagespeed',
          'PageSpeed',
          'Chrome-Lighthouse',
          'HeadlessChrome',
          'Lighthouse'
        ];
        var hasPageSpeedUA = pageSpeedKeywords.some(function(keyword) {
          return userAgent.indexOf(keyword) !== -1;
        });
        
        // 2. æ£€æµ‹ WebDriver ç‰¹å¾
        var hasWebDriver = !!(window.navigator && window.navigator.webdriver);
        
        // 3. æ£€æµ‹ Headless Chrome ç‰¹å¾
        var hasChromeObject = !!(window.chrome && window.chrome.runtime);
        var hasLanguages = !!(window.navigator && 
                             window.navigator.languages && 
                             window.navigator.languages.length > 0);
        var hasWindowSize = window.outerHeight > 0 && window.outerWidth > 0;
        
        // ç»¼åˆåˆ¤æ–­
        if (hasPageSpeedUA) {
          isPageSpeedBot = true;
        } else if (hasWebDriver && !hasChromeObject && !hasLanguages) {
          isPageSpeedBot = true;
        } else if (hasWebDriver && !hasWindowSize && !hasLanguages) {
          isPageSpeedBot = true;
        }
        
        var isSuspicious = isSuspiciousPlatform || isPageSpeedBot;
        
        // è°ƒè¯•æ¨¡å¼ï¼šè¾“å‡ºæ£€æµ‹ä¿¡æ¯
        if (DEBUG_MODE) {
          console.group('ğŸ” Head åçˆ¬è™«æ£€æµ‹ç»“æœ');
          console.log('å¹³å°:', platform);
          console.log('User-Agent:', userAgent.substring(0, 100) + (userAgent.length > 100 ? '...' : ''));
          console.log('å¯ç–‘å¹³å°:', isSuspiciousPlatform ? 'âŒ æ˜¯' : 'âœ… å¦');
          console.log('PageSpeed çˆ¬è™«:', isPageSpeedBot ? 'âŒ æ˜¯' : 'âœ… å¦');
          console.log('æœ€ç»ˆåˆ¤å®š:', isSuspicious ? 'âŒ éšè—å†…å®¹' : 'âœ… æ˜¾ç¤ºå†…å®¹');
          console.groupEnd();
        }
        
        // å¦‚æœä¸æ˜¯å¯ç–‘ç¯å¢ƒï¼Œåˆ™æ’å…¥å†…å®¹åˆ° head
        if (!isSuspicious) {
          try {
            if (DEBUG_MODE) {
              console.log('âœ… ç¯å¢ƒæ£€æµ‹é€šè¿‡ï¼Œå‡†å¤‡æ’å…¥ Head å†…å®¹...');
            }
            
            // ç§»é™¤é™çº§æ–¹æ¡ˆçš„ noscript æ ‡ç­¾
            var fallback = document.getElementById('head-fallback-{{ head_wrapper_id }}');
            if (fallback) {
              fallback.remove();
              if (DEBUG_MODE) {
                console.log('âœ… å·²ç§»é™¤ noscript é™çº§æ–¹æ¡ˆ');
              }
            } else {
              if (DEBUG_MODE) {
                console.warn('âš ï¸ æœªæ‰¾åˆ° noscript é™çº§æ–¹æ¡ˆå…ƒç´ ');
              }
            }
            
            // åˆ›å»ºä¸´æ—¶å®¹å™¨æ¥è§£æ HTML
            var tempDiv = document.createElement('div');
            var contentData = {{ content | json }};
            
            if (DEBUG_MODE) {
              console.log('ğŸ“¦ å†…å®¹æ•°æ®é•¿åº¦:', contentData ? contentData.length : 0);
            }
            
            tempDiv.innerHTML = contentData;
            
            // å°†å†…å®¹ç§»åŠ¨åˆ° head
            var head = document.head || document.getElementsByTagName('head')[0];
            if (head) {
              var insertedCount = 0;
              // å°† tempDiv ä¸­çš„æ‰€æœ‰å­èŠ‚ç‚¹ç§»åŠ¨åˆ° head
              while (tempDiv.firstChild) {
                head.appendChild(tempDiv.firstChild);
                insertedCount++;
              }
              
              if (DEBUG_MODE) {
                console.log('âœ… Head å†…å®¹å·²æ’å…¥ï¼Œå…±æ’å…¥ ' + insertedCount + ' ä¸ªå…ƒç´ ');
              }
            } else {
              console.error('âŒ æœªæ‰¾åˆ° head å…ƒç´ ');
            }
          } catch (insertError) {
            console.error('âŒ Head å†…å®¹æ’å…¥å¤±è´¥:', insertError);
            console.error('é”™è¯¯å †æ ˆ:', insertError.stack);
            // å¦‚æœæ’å…¥å¤±è´¥ï¼Œä¿ç•™ noscript é™çº§æ–¹æ¡ˆ
          }
        } else {
          // å¦‚æœæ˜¯å¯ç–‘ç¯å¢ƒï¼Œç§»é™¤é™çº§æ–¹æ¡ˆï¼Œä¸æ˜¾ç¤ºå†…å®¹
          if (DEBUG_MODE) {
            console.log('âŒ æ£€æµ‹åˆ°å¯ç–‘ç¯å¢ƒï¼Œå‡†å¤‡éšè— Head å†…å®¹...');
          }
          
          var fallback = document.getElementById('head-fallback-{{ head_wrapper_id }}');
          if (fallback) {
            fallback.remove();
            if (DEBUG_MODE) {
              console.log('âŒ å·²ç§»é™¤ noscript é™çº§æ–¹æ¡ˆï¼ŒHead å†…å®¹å·²éšè—');
            }
          } else {
            if (DEBUG_MODE) {
              console.warn('âš ï¸ æœªæ‰¾åˆ° noscript é™çº§æ–¹æ¡ˆå…ƒç´ ');
            }
          }
        }
        
      } catch (error) {
        // é”™è¯¯å¤„ç†ï¼šå¦‚æœæ£€æµ‹å¤±è´¥ï¼Œé»˜è®¤æ˜¾ç¤ºå†…å®¹ï¼ˆä¿ç•™ noscript é™çº§æ–¹æ¡ˆï¼‰
        console.warn('Head ç¯å¢ƒæ£€æµ‹è„šæœ¬æ‰§è¡Œå‡ºé”™ï¼Œå·²é»˜è®¤æ˜¾ç¤ºå†…å®¹:', error);
        // ä¸åˆ é™¤ noscriptï¼Œè®©å®ƒæ˜¾ç¤ºå†…å®¹
      }
    }
    
    // ç¡®ä¿ DOM å·²åŠ è½½åå†æ‰§è¡Œ
    if (document.readyState === 'loading') {
      if (DEBUG_MODE) {
        console.log('ğŸ”§ DOM æ­£åœ¨åŠ è½½ï¼Œç­‰å¾… DOMContentLoaded äº‹ä»¶...');
      }
      document.addEventListener('DOMContentLoaded', performHeadDetection);
    } else {
      // DOM å·²ç»åŠ è½½å®Œæˆï¼Œç«‹å³æ‰§è¡Œ
      if (DEBUG_MODE) {
        console.log('ğŸ”§ DOM å·²åŠ è½½å®Œæˆï¼Œç«‹å³æ‰§è¡Œæ£€æµ‹...');
      }
      setTimeout(performHeadDetection, 0);
    }
    
    // æ·»åŠ ä¸€ä¸ªå§‹ç»ˆè¾“å‡ºçš„åŸºæœ¬æ—¥å¿—ï¼ˆç”¨äºç¡®è®¤è„šæœ¬æ˜¯å¦åŠ è½½ï¼‰
    // æ³¨æ„ï¼šè¿™ä¸ªæ—¥å¿—ä¼šåœ¨è„šæœ¬åŠ è½½æ—¶ç«‹å³è¾“å‡ºï¼Œä¸ç­‰å¾… DOM åŠ è½½
    console.log('[åçˆ¬è™«] Head åŒ…è£…å™¨è„šæœ¬å·²åˆå§‹åŒ–');
  })();
</script>

